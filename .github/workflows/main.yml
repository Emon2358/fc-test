name: Build NES ROM (MIDI Player)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Toolchain
        run: |
          sudo apt-get update
          # cc65 (アセンブラ) と Python (pip) をインストール
          sudo apt-get install -y cc65 wget python3-pip
          # PythonのMIDI解析ライブラリ 'mido' をインストール
          pip3 install mido

      - name: 3. Download Source MIDI
        run: |
          set -e
          mkdir -p build
          # MP4の代わりに、hert01.mid をダウンロード (リポジトリに置く場合は不要)
          wget https://github.com/Emon2358/fc-test/raw/main/media/hert01.mid -O build/hert01.mid
          # (もしhert01.midをリポジトリのルートに置く場合は、
          #  cp hert01.mid build/hert01.mid に変更してください)

      - name: 4. Convert MIDI to NES Data
        run: |
          set -e
          # Pythonスクリプトで MIDI を NES用音楽データに変換
          python3 tools/midi_converter.py build/hert01.mid build/music_data.bin

      - name: 5. Assemble the ROM
        run: |
          set -e
          # (FRAME_COUNT は不要になったため削除)
          ca65 src/player.asm -o build/player.o
          ld65 -C src/mmc3.cfg -o build/BGM_Player.nes build/player.o --lib nes.lib

      - name: 6. Upload NES ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bgm-rom
          path: build/BGM_Player.nes
