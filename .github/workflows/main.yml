name: Build NES ROM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Toolchain
        run: |
          sudo apt-get update
          # Pythonライブラリのインストーラ pip と、cc65, ffmpeg, wget をインストール
          sudo apt-get install -y ffmpeg cc65 wget python3-pip
          # Pythonスクリプトに必要なライブラリをインストール
          pip3 install pillow numpy scipy

      # (旧 Step 3, 4 は削除)

      - name: 3. Prepare Source Assets (URL Download)
        run: |
          set -e
          mkdir -p build
          wget https://raw.githubusercontent.com/Emon2358/fc-test/main/media/RPReplay_Final1762760800.mov -O build/RPReplay_Final1762760800.mov
          
          mkdir -p build/frames
          # 15fps, 256x224 (NESの安全領域) にリサイズ
          ffmpeg -i build/ruri_scene.mp4 -vf "fps=15,scale=256:224,crop=256:224" build/frames/frame_%04d.png
          # DPCM用に 15734Hz モノラル 16bit PCM でWAVを抽出
          ffmpeg -i build/ruri_scene.mp4 -ar 15734 -ac 1 -sample_fmt s16 build/audio.wav
          
          ls build/frames/*.png | wc -l > build/frame_count.txt

      - name: 4. Convert Audio using Python Script
        run: |
          set -e
          python3 tools/wav2dmc.py build/audio.wav build/sound.dmc

      - name: 5. Convert Video using Python Script
        run: |
          set -e
          # Pythonスクリプトで CHR (タイル) と MAP (差分データ) を生成
          python3 tools/video_converter.py build/frames build/video_chr.bin build/video_map.bin

      - name: 6. Assemble the ROM
        run: |
          set -e
          FRAME_COUNT=$(cat build/frame_count.txt)
          echo "Total Frames: $FRAME_COUNT"
          ca65 src/player.asm -D FRAME_COUNT=$FRAME_COUNT -o build/player.o
          ld65 -C src/mmc3.cfg -o build/RuriHoshino.nes build/player.o --lib nes.lib

      - name: 7. Upload NES ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nadesico-rom
          path: build/RuriHoshino.nes
