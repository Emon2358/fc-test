name: Build NES ROM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        # アセンブリコード (src/*) を読み込むために必要
        uses: actions/checkout@v4

      - name: 2. Setup Toolchain
        run: |
          sudo apt-get update
          # wget をインストールリストに追加
          sudo apt-get install -y ffmpeg cc65 git build-essential cmake wget

      - name: 3. Download & Build DPCM Converter (dpcmc)
        run: |
          git clone https://github.com/osoumen/dpcmc.git dpcmc_build
          cd dpcmc_build/src
          make
          sudo mv dpcmc /usr/local/bin/

      - name: 4. Download & Build Video Converter (NesTiler)
        run: |
          git clone https://github.com/ClusterM/NesTiler.git NesTiler_build
          cd NesTiler_build
          mkdir build && cd build
          cmake ..
          make
          sudo mv NesTiler /usr/local/bin/

      - name: 5. Prepare Source Assets (URL Download) - [修正]
        run: |
          mkdir -p build
          # GitHubのURLからrawファイルをダウンロード
          wget https://raw.githubusercontent.com/Emon2358/fc-test/main/media/ruri_scene.mp4 -O build/ruri_scene.mp4
          
          mkdir -p build/frames
          # ダウンロードした動画ファイルをPNGに変換
          ffmpeg -i build/ruri_scene.mp4 -vf "fps=15,scale=256:240" build/frames/frame_%04d.png
          # ダウンロードした動画ファイルから音声を抽出
          ffmpeg -i build/ruri_scene.mp4 -ar 15734 -ac 1 build/audio.wav
          
          # 処理するフレーム数をカウント
          ls build/frames/*.png | wc -l > build/frame_count.txt

      - name: 6. Convert Audio using dpcmc
        run: dpcmc -v64 -sN build/audio.wav build/sound.dmc

      - name: 7. Convert Video using NesTiler
        run: |
          nestiler -i "build/frames/frame_#04d.png" \
                   -p "build/video_chr.bin" \
                   -m "build/video_map.bin" \
                   --mode=video \
                   --pack-patterns

      - name: 8. Assemble the ROM
        run: |
          FRAME_COUNT=$(cat build/frame_count.txt)
          echo "Total Frames: $FRAME_COUNT"
          ca65 src/player.asm -D FRAME_COUNT=$FRAME_COUNT -o build/player.o
          ld65 -C src/mmc3.cfg -o build/RuriHoshino.nes build/player.o --lib nes.lib

      - name: 9. Upload NES ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nadesico-rom
          path: build/RuriHoshino.nes
