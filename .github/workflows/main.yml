name: Build NES ROM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    # 実行環境を Linux (Ubuntu) に戻します
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Toolchain
        run: |
          sudo apt-get update
          # python3 と pip を追加
          sudo apt-get install -y ffmpeg cc65 git build-essential cmake wget python3 python3-pip

      - name: 3. Download Audio Converter (pywav2dmc) - [修正]
        # dpcmcの代わりに、Pythonスクリプトをダウンロードします (ビルド不要)
        run: |
          set -e
          wget https://raw.githubusercontent.com/mstopa/pywav2dmc/master/pywav2dmc.py
          chmod +x pywav2dmc.py

      - name: 4. Download & Build Video Converter (NesTiler)
        # こちらは Linux でビルドします
        run: |
          set -e
          git clone https://github.com/ClusterM/NesTiler.git NesTiler_build
          cd NesTiler_build
          mkdir build && cd build
          cmake .. && make && sudo mv NesTiler /usr/local/bin/

      - name: 5. Prepare Source Assets (URL Download)
        run: |
          set -e
          mkdir -p build
          wget https://raw.githubusercontent.com/Emon2358/fc-test/main/media/ruri_scene.mp4 -O build/ruri_scene.mp4
          
          mkdir -p build/frames
          ffmpeg -i build/ruri_scene.mp4 -vf "fps=15,scale=256:240" build/frames/frame_%04d.png
          ffmpeg -i build/ruri_scene.mp4 -ar 15734 -ac 1 build/audio.wav
          
          ls build/frames/*.png | wc -l > build/frame_count.txt

      - name: 6. Convert Audio using pywav2dmc - [修正]
        run: |
          set -e
          # ダウンロードしたPythonスクリプトでDPCMに変換します
          python3 pywav2dmc.py build/audio.wav build/sound.dmc

      - name: 7. Convert Video using NesTiler
        run: |
          set -e
          nestiler -i "build/frames/frame_#04d.png" \
                   -p "build/video_chr.bin" \
                   -m "build/video_map.bin" \
                   --mode=video \
                   --pack-patterns

      - name: 8. Assemble the ROM
        run: |
          set -e
          FRAME_COUNT=$(cat build/frame_count.txt)
          echo "Total Frames: $FRAME_COUNT"
          ca65 src/player.asm -D FRAME_COUNT=$FRAME_COUNT -o build/player.o
          # 出力ファイル名のタイポを修正 (RuriHsinones -> RuriHoshino.nes)
          ld65 -C src/mmc3.cfg -o build/RuriHoshino.nes build/player.o --lib nes.lib

      - name: 9. Upload NES ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nadesico-rom
          path: build/RuriHoshino.nes
