name: Build NES ROM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg cc65 git build-essential cmake

      - name: 3. Download & Build DPCM Converter (dpcmc) - [修正]
        # /tmp ではなく、ワークスペース内に "dpcmc_build" という名前でクローンします
        run: |
          git clone https://github.com/osoumen/dpcmc.git dpcmc_build
          make -C dpcmc_build/src
          sudo mv dpcmc_build/bin/dpcmc /usr/local/bin/

      - name: 4. Download & Build Video Converter (NesTiler)
        run: |
          git clone https://github.com/ClusterM/NesTiler.git /tmp/NesTiler
          cd /tmp/NesTiler
          mkdir build && cd build
          cmake ..
          make
          sudo mv NesTiler /usr/local/bin/

      - name: 5. Prepare Source Assets
        run: |
          mkdir -p build/frames
          # 元の動画ファイルを 256x240 (フルスクリーン), 15fpsでPNGに
          ffmpeg -i ji-dong-zhan-jian-natesiko-hosinoruri-jin-du-haanatanoyi-fan-ninaritai-tatute-ytshorts.savetube.me.mp4 -vf "fps=15,scale=256:240" build/frames/frame_%04d.png
          # 音声をDPCM用に抽出
          ffmpeg -i ji-dong-zhan-jian-natesiko-hosinoruri-jin-du-haanatanoyi-fan-ninaritai-tatute-ytshorts.savetube.me.mp4 -ar 15734 -ac 1 build/audio.wav
          # 処理するフレーム数をカウント (アセンブリでのループ用)
          ls build/frames/*.png | wc -l > build/frame_count.txt

      - name: 6. Convert Audio using dpcmc
        run: dpcmc -v64 -sN build/audio.wav build/sound.dmc

      - name: 7. Convert Video using NesTiler
        run: |
          nestiler -i "build/frames/frame_#04d.png" \
                   -p "build/video_chr.bin" \
                   -m "build/video_map.bin" \
                   --mode=video \
                   --pack-patterns

      - name: 8. Assemble the ROM
        run: |
          FRAME_COUNT=$(cat build/frame_count.txt)
          echo "Total Frames: $FRAME_COUNT"
          ca65 src/player.asm -D FRAME_COUNT=$FRAME_COUNT -o build/player.o
          ld65 -C src/mmc3.cfg -o build/RuriHoshino.nes build/player.o --lib nes.lib

      - name: 9. Upload NES ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nadesico-rom
          path: build/RuriHoshino.nes
